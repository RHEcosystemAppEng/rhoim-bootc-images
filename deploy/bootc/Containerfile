# Start with a suitable base image for UBI and bootc
FROM registry.access.redhat.com/ubi9/ubi-minimal:latest

# --- Configuration ---
ENV MODEL_ID="TinyLlama/TinyLlama-1.1B-Chat-v1.0"
ENV MODEL_PATH="/opt-app-root/models"
ENV VLLM_PORT="8000"
ENV VLLM_HOST="0.0.0.0"
ENV PYTHONUNBUFFERED=1
ENV VENV_PATH=/opt-app-root/venv
ENV VLLM_NO_CUDA="1"

# 1. Install necessary system packages for runtime and build tools
# ðŸ”¥ FIX 1: Added 'kmod' (which provides the 'lsmod' command)
RUN microdnf update -y && microdnf install -y \
    gcc git tar gzip systemd procps-ng iproute kmod \
    \
    # Install Python 3.11 and development packages directly
    && microdnf install -y python3.11 python3.11-pip python3.11-devel \
    \
    && microdnf clean all

# 2. Setup Python Virtual Environment
# Use the explicit python3.11 executable
RUN /usr/bin/python3.11 -m venv $VENV_PATH
ENV PATH="$VENV_PATH/bin:$PATH"

# 3. Install Python Dependencies
# Path updated to be relative to the build root
COPY deploy/bootc/requirements.txt .

# ðŸ”¥ FIX 2: Pre-install build-time dependencies (numpy and wheel)
RUN pip install --no-cache-dir wheel numpy \
    --index-url https://download.pytorch.org/whl/cpu \
    --extra-index-url https://pypi.org/simple

# Now, install the actual requirements
RUN pip install --no-cache-dir -r requirements.txt \
    --index-url https://download.pytorch.org/whl/cpu \
    --extra-index-url https://pypi.org/simple
    
# 4. Create model directory and expose port
RUN mkdir -p $MODEL_PATH
EXPOSE 8000
EXPOSE 8080

# 5. Add Systemd service components (VLLM and Gateway)
# All paths updated to be relative to the build root
COPY deploy/bootc/rhoim.env /etc/sysconfig/rhoim

# Copy and enable the VLLM model serving service
COPY deploy/bootc/rhoim-vllm.service /etc/systemd/system/rhoim-vllm.service
COPY deploy/bootc/initializer-entrypoint.sh /usr/local/bin/initializer-entrypoint.sh
RUN chmod +x /usr/local/bin/initializer-entrypoint.sh
RUN systemctl enable rhoim-vllm.service

# Copy and enable the RHOIM Gateway service (This path is correct relative to root)
COPY gateway/app /opt/rhoim/gateway
COPY deploy/bootc/rhoim-gateway.service /etc/systemd/system/rhoim-gateway.service
RUN systemctl enable rhoim-gateway.service

# 6. Final Command: Initialize Systemd (Mandatory for bootc)
CMD ["/sbin/init"]