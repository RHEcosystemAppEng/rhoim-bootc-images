# =============================================================================
# Bootc Base Image with Podman and NVIDIA CUDA Libraries
# This image will run the vLLM container using podman on boot
# =============================================================================
FROM registry.redhat.io/rhel9/rhel-bootc:latest

# Install podman and NVIDIA CUDA libraries dependencies
# These are needed to run the vLLM CUDA container
# Mount RHSM secrets to enable repository access during build
# Create repo files directly using CDN URLs (subscription-manager doesn't work in containers)
RUN --mount=type=secret,id=rhsm,target=/tmp/rhsm.conf \
    --mount=type=secret,id=ca,target=/tmp/redhat-uep.pem \
    --mount=type=secret,id=key,target=/tmp/key.pem \
    --mount=type=secret,id=cert,target=/tmp/cert.pem \
    mkdir -p /etc/rhsm/ca /etc/pki/entitlement /etc/yum.repos.d && \
    cp /tmp/rhsm.conf /etc/rhsm/rhsm.conf && \
    cp /tmp/redhat-uep.pem /etc/rhsm/ca/redhat-uep.pem && \
    cp /tmp/key.pem /etc/pki/entitlement/key.pem && \
    cp /tmp/cert.pem /etc/pki/entitlement/cert.pem && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-baseos-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/baseos/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-baseos.repo && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-appstream-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/appstream/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-appstream.repo && \
    dnf -v -y install podman skopeo systemd && \
    dnf clean all

# =============================================================================
# NVIDIA GPU Driver Installation
# =============================================================================
# For GPU support, we need to install NVIDIA drivers in the bootc image during build.
# This includes:
#   - nvidia-driver: Proprietary NVIDIA kernel modules and userspace libraries
#   - nvidia-driver-cuda: CUDA support and nvidia-smi tool
#   - nvidia-container-toolkit: Container runtime support for GPU access
#
# Note: Drivers must be installed during build because:
#   1. Bootc images have read-only root filesystem at runtime
#   2. Kernel modules need to match the kernel version
#   3. Build tools (gcc, kernel-devel) are only available during build
#
# After installation, nvidia-container-setup.service will configure GPU access
# for containers at boot time.
# =============================================================================

# Add NVIDIA CUDA repository (contains nvidia-driver packages)
RUN dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo

# Install NVIDIA Container Toolkit (required for GPU access in containers)
# This enables containers to access GPU devices via CDI (Container Device Interface)
RUN curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
      tee /etc/yum.repos.d/nvidia-container-toolkit.repo && \
    dnf -y install --nogpgcheck nvidia-container-toolkit && \
    dnf clean all

# Install NVIDIA GPU Drivers (proprietary drivers with full CUDA support)
# These are needed on the host OS for GPU access from containers
# We install the full proprietary NVIDIA driver stack (not just open-source modules)
# This includes nvidia-smi, CUDA support, and kernel modules
# Note: Requires RHEL repos during build for dependencies (gcc, kernel-devel, etc.)
RUN --mount=type=secret,id=rhsm,target=/tmp/rhsm.conf \
    --mount=type=secret,id=ca,target=/tmp/redhat-uep.pem \
    --mount=type=secret,id=key,target=/tmp/key.pem \
    --mount=type=secret,id=cert,target=/tmp/cert.pem \
    mkdir -p /etc/rhsm/ca /etc/pki/entitlement /etc/yum.repos.d && \
    cp /tmp/rhsm.conf /etc/rhsm/rhsm.conf && \
    cp /tmp/redhat-uep.pem /etc/rhsm/ca/redhat-uep.pem && \
    cp /tmp/key.pem /etc/pki/entitlement/key.pem && \
    cp /tmp/cert.pem /etc/pki/entitlement/cert.pem && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-baseos-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/baseos/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-baseos.repo && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-appstream-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/appstream/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-appstream.repo && \
    KERNEL_VERSION=$(uname -r) && \
    echo "=== Installing NVIDIA GPU Drivers ===" && \
    echo "Kernel version: ${KERNEL_VERSION}" && \
    echo "Installing build dependencies..." && \
    dnf -y install gcc make patch elfutils-libelf-devel && \
    echo "Installing kernel development packages..." && \
    dnf -y install kernel-devel-${KERNEL_VERSION} 2>/dev/null || \
    dnf -y install kernel-devel kernel-headers && \
    echo "Installing EPEL for DKMS..." && \
    dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm && \
    echo "Installing DKMS..." && \
    dnf -y install dkms && \
    echo "Installing NVIDIA driver packages from CUDA repository..." && \
    dnf -y install nvidia-driver nvidia-driver-cuda && \
    echo "âœ… NVIDIA drivers installed successfully" && \
    echo "Verifying installation..." && \
    rpm -q nvidia-driver nvidia-driver-cuda && \
    echo "=== Checking for NVIDIA kernel modules ===" && \
    KERNEL_VERSION=$(uname -r) && \
    echo "Build kernel version: ${KERNEL_VERSION}" && \
    echo "Checking for modules in /lib/modules/${KERNEL_VERSION}:" && \
    find /lib/modules/${KERNEL_VERSION} -name "nvidia.ko*" 2>/dev/null | head -5 || echo "No nvidia.ko found" && \
    echo "Checking for modules in /usr/lib/modules:" && \
    find /usr/lib/modules -name "nvidia.ko*" 2>/dev/null | head -5 || echo "No nvidia.ko found in /usr/lib/modules" && \
    echo "Checking modinfo:" && \
    modinfo nvidia 2>&1 | head -10 || echo "modinfo nvidia failed" && \
    echo "Checking DKMS status:" && \
    dkms status 2>&1 | grep -i nvidia || echo "No NVIDIA modules in DKMS" && \
    dnf clean all

# Remove RHEL repo files and entitlements after all package installations are complete
# This prevents the image from trying to access repos at runtime without credentials
RUN rm -f /etc/yum.repos.d/rhel9-baseos.repo /etc/yum.repos.d/rhel9-appstream.repo && \
    rm -rf /etc/rhsm /etc/pki/entitlement

# Enable and start podman socket
RUN systemctl enable podman.socket

# Copy systemd service and configuration files
COPY etc/ /etc/

# Copy scripts
COPY scripts/nvidia-container-setup.sh /usr/local/bin/nvidia-container-setup.sh
COPY scripts/run-vllm-container.sh /usr/local/bin/run-vllm-container.sh
COPY scripts/podman-registry-login.sh /usr/local/bin/podman-registry-login.sh

# Create template file in base image at /usr/share/rhoim (read-only base filesystem)
# This will be copied to /var/lib/rhoim at boot by tmpfiles.d
# We include a base template here; credentials will be injected during AMI creation
RUN mkdir -p /usr/share/rhoim && \
    cp /etc/sysconfig/rhoim /usr/share/rhoim/rhoim.template

# Create necessary directories and setup
RUN chmod +x /usr/local/bin/nvidia-container-setup.sh && \
    chmod +x /usr/local/bin/run-vllm-container.sh && \
    chmod +x /usr/local/bin/podman-registry-login.sh && \
    mkdir -p /opt/rhoim/{bin,models,gateway} /tmp/models && \
    # Create /sysroot directory required by bootc lint
    mkdir -p /sysroot && \
    # Create podman auth directory for registry credentials (required for --authfile)
    mkdir -p /root/.config/containers && \
    # Enable services
    systemctl enable nvidia-container-setup.service && \
    systemctl enable podman-registry-login.service && \
    systemctl enable rhoim-vllm.service

# vLLM listens here
EXPOSE 8000

# Mark as bootc-compatible
LABEL org.osbuild.bootc=true \
      bootc=true

# Clean up build artifacts to reduce bootc lint warnings
# Remove log files and dnf cache to satisfy bootc lint requirements
RUN rm -rf /var/log/*.log /var/log/dnf* /var/log/rhsm && \
    rm -rf /var/cache/dnf/* && \
    rm -rf /var/lib/dkms/nvidia/*/source && \
    rm -rf /var/roothome/buildinfo && \
    # Create tmpfiles.d entries for required /var directories
    mkdir -p /etc/tmpfiles.d && \
    printf 'd /var/cache/dnf 0755 root root -\n' > /etc/tmpfiles.d/dnf-cache.conf && \
    printf 'd /var/lib/dkms 0755 root root -\n' > /etc/tmpfiles.d/dkms.conf

# Final bootc lint step
RUN bootc container lint || echo "Bootc lint completed with warnings"

# Bootc images must run systemd as PID 1
CMD ["/sbin/init"]
