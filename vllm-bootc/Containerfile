# =============================================================================
# Bootc Base Image with Podman and NVIDIA CUDA Libraries
# This image will run the vLLM container using podman on boot
# =============================================================================
FROM registry.redhat.io/rhel9/rhel-bootc:latest

# Install podman and NVIDIA CUDA libraries dependencies
# These are needed to run the vLLM CUDA container
# Mount RHSM secrets to enable repository access during build
# Create repo files directly using CDN URLs (subscription-manager doesn't work in containers)
RUN --mount=type=secret,id=rhsm,target=/tmp/rhsm.conf \
    --mount=type=secret,id=ca,target=/tmp/redhat-uep.pem \
    --mount=type=secret,id=key,target=/tmp/key.pem \
    --mount=type=secret,id=cert,target=/tmp/cert.pem \
    mkdir -p /etc/rhsm/ca /etc/pki/entitlement /etc/yum.repos.d && \
    cp /tmp/rhsm.conf /etc/rhsm/rhsm.conf && \
    cp /tmp/redhat-uep.pem /etc/rhsm/ca/redhat-uep.pem && \
    cp /tmp/key.pem /etc/pki/entitlement/key.pem && \
    cp /tmp/cert.pem /etc/pki/entitlement/cert.pem && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-baseos-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/baseos/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-baseos.repo && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-appstream-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/appstream/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-appstream.repo && \
    dnf -v -y install podman skopeo systemd && \
    dnf clean all

# Add NVIDIA CUDA repository
RUN dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo

# Install NVIDIA Container Toolkit (required for GPU access in containers)
# Note: We keep RHEL repos enabled for potential dependencies
RUN curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
      tee /etc/yum.repos.d/nvidia-container-toolkit.repo && \
    dnf -y install --nogpgcheck nvidia-container-toolkit && \
    dnf clean all

# Install NVIDIA kernel modules
# These are needed on the host OS for GPU access from containers
# We install during build when RHEL repos are available
# Note: kmod-nvidia-open-dkms uses DKMS which will compile modules during build
#       if pre-compiled versions aren't available. Build tools are removed after installation.
RUN --mount=type=secret,id=rhsm,target=/tmp/rhsm.conf \
    --mount=type=secret,id=ca,target=/tmp/redhat-uep.pem \
    --mount=type=secret,id=key,target=/tmp/key.pem \
    --mount=type=secret,id=cert,target=/tmp/cert.pem \
    mkdir -p /etc/rhsm/ca /etc/pki/entitlement /etc/yum.repos.d && \
    cp /tmp/rhsm.conf /etc/rhsm/rhsm.conf && \
    cp /tmp/redhat-uep.pem /etc/rhsm/ca/redhat-uep.pem && \
    cp /tmp/key.pem /etc/pki/entitlement/key.pem && \
    cp /tmp/cert.pem /etc/pki/entitlement/cert.pem && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-baseos-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/baseos/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-baseos.repo && \
    printf '%s\n' \
      '[rhel-9-for-x86_64-appstream-rpms]' \
      'name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)' \
      'baseurl=https://cdn.redhat.com/content/dist/rhel9/9/x86_64/appstream/os' \
      'enabled=1' \
      'gpgcheck=1' \
      'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' \
      'sslverify=1' \
      'sslcacert=/etc/rhsm/ca/redhat-uep.pem' \
      'sslclientkey=/etc/pki/entitlement/key.pem' \
      'sslclientcert=/etc/pki/entitlement/cert.pem' \
      'metadata_expire=86400' \
      'enabled_metadata=1' > /etc/yum.repos.d/rhel9-appstream.repo && \
    KERNEL_VERSION=$(uname -r) && \
    echo "Installing NVIDIA kernel modules for kernel: ${KERNEL_VERSION}" && \
    echo "Installing build tools..." && \
    dnf -y install gcc make && \
    echo "Installing kernel-devel (trying exact version first, then latest available)..." && \
    dnf -y install kernel-devel-${KERNEL_VERSION} 2>/dev/null || \
    dnf -y install kernel-devel kernel-headers && \
    echo "Adding EPEL repository for dkms..." && \
    dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm && \
    echo "Installing DKMS from EPEL..." && \
    dnf -y install dkms && \
    echo "Installing NVIDIA kernel module packages..." && \
    dnf -y install kmod-nvidia-open-dkms nvidia-kmod-common && \
    echo "NVIDIA kernel modules installed. Removing build tools (keeping dkms, kernel-devel, and kernel-headers for runtime module building)..." && \
    dnf -y remove gcc make && \
    dnf clean all

# Remove RHEL repo files and entitlements after all package installations are complete
# This prevents the image from trying to access repos at runtime without credentials
RUN rm -f /etc/yum.repos.d/rhel9-baseos.repo /etc/yum.repos.d/rhel9-appstream.repo && \
    rm -rf /etc/rhsm /etc/pki/entitlement

# Enable and start podman socket
RUN systemctl enable podman.socket

# Copy systemd service and configuration files
COPY etc/ /etc/

# Copy scripts
COPY scripts/nvidia-container-setup.sh /usr/local/bin/nvidia-container-setup.sh
COPY scripts/run-vllm-container.sh /usr/local/bin/run-vllm-container.sh
COPY scripts/podman-registry-login.sh /usr/local/bin/podman-registry-login.sh

# Create necessary directories and setup
RUN chmod +x /usr/local/bin/nvidia-container-setup.sh && \
    chmod +x /usr/local/bin/run-vllm-container.sh && \
    chmod +x /usr/local/bin/podman-registry-login.sh && \
    mkdir -p /opt/rhoim/{bin,models,gateway} /tmp/models && \
    # Create /sysroot directory required by bootc lint
    mkdir -p /sysroot && \
    # Create podman auth directory for registry credentials (required for --authfile)
    mkdir -p /root/.config/containers && \
    # Enable services
    systemctl enable nvidia-container-setup.service && \
    systemctl enable podman-registry-login.service && \
    systemctl enable rhoim-vllm.service

# vLLM listens here
EXPOSE 8000

# Mark as bootc-compatible
LABEL org.osbuild.bootc=true \
      bootc=true

# Final bootc lint step
RUN bootc container lint || echo "Bootc lint completed with warnings"

# Bootc images must run systemd as PID 1
CMD ["/sbin/init"]
