# =============================================================================
# Bootc Base Image with Podman and NVIDIA CUDA Libraries
# This image will run the vLLM container using podman on boot
# =============================================================================
FROM registry.redhat.io/rhel9/rhel-bootc:latest

# Install podman and NVIDIA CUDA libraries dependencies
# These are needed to run the vLLM CUDA container
RUN dnf -y install \
      podman \
      skopeo \
      systemd \
    && dnf clean all

# Add NVIDIA CUDA repository
RUN dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo

# Install NVIDIA Container Toolkit (required for GPU access in containers)
RUN curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
      tee /etc/yum.repos.d/nvidia-container-toolkit.repo && \
    dnf -y install --nogpgcheck nvidia-container-toolkit && \
    dnf clean all

# Enable and start podman socket
RUN systemctl enable podman.socket

# Copy systemd service and configuration files
COPY etc/ /etc/

# Copy scripts
COPY scripts/nvidia-container-setup.sh /usr/local/bin/nvidia-container-setup.sh
COPY scripts/run-vllm-container.sh /usr/local/bin/run-vllm-container.sh
COPY scripts/podman-registry-login.sh /usr/local/bin/podman-registry-login.sh

# Create necessary directories and setup
RUN chmod +x /usr/local/bin/nvidia-container-setup.sh && \
    chmod +x /usr/local/bin/run-vllm-container.sh && \
    chmod +x /usr/local/bin/podman-registry-login.sh && \
    mkdir -p /opt/rhoim/{bin,models,gateway} /tmp/models && \
    # Create /sysroot directory required by bootc lint
    mkdir -p /sysroot && \
    # Enable services
    systemctl enable nvidia-container-setup.service && \
    systemctl enable podman-registry-login.service && \
    systemctl enable rhoim-vllm.service

# vLLM listens here
EXPOSE 8000

# Mark as bootc-compatible
LABEL org.osbuild.bootc=true \
      bootc=true

# Final bootc lint step
RUN bootc container lint || echo "Bootc lint completed with warnings"

# Bootc images must run systemd as PID 1
CMD ["/sbin/init"]
